<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quantum WebIDE ‚Äî Mobile-First, Privileged Proxy Shell</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#111827">
  <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Mobile-first, dark mode, high-contrast, accessibility */
    html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: #111827; color: #e5e7eb;}
    .app-container { min-height: 100vh; display: flex; flex-direction: column; }
    .header { background: #181f2a; color: #5eead4; padding: 1em 0.5em; border-bottom: 2px solid #6366f1; font-family: 'Fira Code', monospace; font-size: 1.4em;}
    .content { flex: 1; display: flex; flex-direction: row; overflow: hidden;}
    .sidebar { width: 260px; background: #1a202c; border-right: 2px solid #6366f1; padding: 0.8em 0.5em; flex-shrink: 0; display: flex; flex-direction: column; }
    .sidebar h2 { font-size: 1.1em; color: #818cf8; margin-bottom: 0.5em;}
    .sidebar button, .sidebar .menu-btn { background: #23243d; color: #5eead4; border: none; padding: 0.5em 0.8em; border-radius: 0.5em; margin-bottom: 0.3em; font-family: 'Fira Code', monospace; cursor: pointer;}
    .sidebar button.active, .sidebar .menu-btn.active { background: #6366f1; color: #fff;}
    .main { flex: 1; display: flex; flex-direction: column; padding: 1em; overflow: auto;}
    @media (max-width: 900px) {
      .content { flex-direction: column;}
      .sidebar { width: 100%; border-right: none; border-bottom: 2px solid #6366f1;}
      .main { padding: 0.5em;}
    }
    .terminal-container { background: #181f2a; border-radius: 1em; padding: 1em; margin-bottom: 1em;}
    #terminal { height: 250px; width: 100%; background: #181f2a;}
    .editor-container { background: #181f2a; border-radius: 1em; padding: 1em; margin-bottom: 1em;}
    #editor { width: 100%; height: 180px; background: #23243d; color: #e0e7ff; border-radius: 0.5em; border: none; font-family: 'Fira Code', monospace; font-size: 1em; padding: 0.7em;}
    .file-list { max-height: 180px; overflow-y: auto; background: #23243d; border-radius: 0.5em; margin-bottom: 1em;}
    .file-btn { display: block; width: 100%; background: none; color: #5eead4; padding: 0.4em 1em; border: none; text-align: left; font-family: 'Fira Code', monospace; border-bottom: 1px solid #181f2a; cursor: pointer;}
    .file-btn.active { background: #6366f1; color: #fff;}
    .proxy-container { background: #181f2a; border-radius: 1em; padding: 1em; margin-bottom: 1em;}
    .output { background: #23243d; color: #a7f3d0; border-radius: 0.5em; padding: 1em; margin-bottom: 1em; white-space: pre-wrap; font-size: 0.95em;}
    .btn { background: #6366f1; color: #fff; border: none; border-radius: 0.5em; padding: 0.6em 1.3em; font-size: 1em; font-weight: 500; cursor: pointer; margin: 0.2em;}
    .btn:hover { background: #7c3aed;}
    .status-indicator { font-size: 0.9em; color: #fbbf24;}
    .ai-chat { background: #181f2a; border-radius: 1em; padding: 1em;}
    .chatbox { background: #23243d; border-radius: 0.5em; padding: 1em; min-height: 120px; max-height: 210px; overflow-y: auto; margin-bottom: 1em;}
    .chat-msg { margin-bottom: 1em;}
    .chat-user { color: #d1fae5; font-weight: bold;}
    .chat-ai { color: #fbbf24; font-weight: bold;}
    .chat-text { color: #e0e7ff;}
    .chat-input { width: 100%; padding: 0.6em; border-radius: 0.5em; background: #23243d; color: #fff; border: none; font-family: 'Fira Code', monospace; margin-right: 1em;}
    /* Copilot Cookbook Styles */
    .cookbook-container { background: #181f2a; border-radius: 1em; padding: 1em; max-height: 80vh; overflow-y: auto;}
    .cookbook-header { margin-bottom: 1.5em;}
    .cookbook-header h3 { color: #5eead4; margin-bottom: 0.5em; font-size: 1.3em;}
    .cookbook-header p { color: #a7f3d0; margin-bottom: 1em; font-size: 0.9em;}
    .cookbook-search { display: flex; gap: 0.5em; flex-wrap: wrap;}
    .cookbook-example-list { display: grid; gap: 1em;}
    .cookbook-example { background: #23243d; border-radius: 0.5em; padding: 1em; border-left: 4px solid #6366f1; cursor: pointer; transition: all 0.2s;}
    .cookbook-example:hover { background: #2d2e4d; border-left-color: #fbbf24;}
    .cookbook-example.android { border-left-color: #10b981;}
    .cookbook-example-title { color: #5eead4; font-weight: bold; margin-bottom: 0.5em; display: flex; align-items: center; gap: 0.5em;}
    .cookbook-example-difficulty { background: #6366f1; color: #fff; padding: 0.2em 0.6em; border-radius: 1em; font-size: 0.8em;}
    .cookbook-example-difficulty.Simple { background: #10b981;}
    .cookbook-example-difficulty.Intermediate { background: #f59e0b;}
    .cookbook-example-difficulty.Advanced { background: #ef4444;}
    .cookbook-example-description { color: #e0e7ff; font-size: 0.9em; margin-bottom: 0.5em;}
    .cookbook-example-tags { display: flex; gap: 0.3em; flex-wrap: wrap;}
    .cookbook-tag { background: #374151; color: #d1d5db; padding: 0.2em 0.5em; border-radius: 0.3em; font-size: 0.75em;}
    .cookbook-tag.android { background: #065f46; color: #d1fae5;}
    .cookbook-detail { background: #23243d; border-radius: 0.5em; padding: 1.5em;}
    .cookbook-detail h4 { color: #5eead4; margin-bottom: 1em;}
    .cookbook-prompt { background: #1f2937; border-radius: 0.5em; padding: 1em; margin: 1em 0; border-left: 4px solid #10b981;}
    .cookbook-prompt pre { color: #e0e7ff; font-family: 'Fira Code', monospace; white-space: pre-wrap; margin: 0;}
    .cookbook-use-case { background: #374151; border-radius: 0.5em; padding: 1em; margin: 1em 0;}
    .cookbook-use-case h5 { color: #fbbf24; margin-bottom: 0.5em;}
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px;}
    ::-webkit-scrollbar-track { background: #222;}
    ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px;}
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      Quantum WebIDE ‚Äî Mobile-First Privileged Proxy Shell <span class="status-indicator" id="status-indicator"></span>
    </div>
    <div class="content">
      <!-- Sidebar: Navigation -->
      <div class="sidebar">
        <h2>Navigation</h2>
        <button class="menu-btn active" id="nav-terminal">Terminal</button>
        <button class="menu-btn" id="nav-editor">Editor</button>
        <button class="menu-btn" id="nav-proxy">Proxy</button>
        <button class="menu-btn" id="nav-ai">AI Chat</button>
        <button class="menu-btn" id="nav-cookbook">üìö Copilot Cookbook</button>
        <button class="menu-btn" id="nav-settings">Settings</button>
        <h2>Files</h2>
        <div class="file-list" id="file-list"></div>
      </div>
      <!-- Main Panel: Terminal/Editor/Proxy/AI -->
      <div class="main">
        <!-- Terminal -->
        <div class="terminal-container" id="panel-terminal">
          <div id="terminal"></div>
        </div>
        <!-- Editor -->
        <div class="editor-container" id="panel-editor" style="display:none;">
          <textarea id="editor" placeholder="Edit code here..."></textarea>
          <div>
            <button class="btn" id="save-file-btn">Save</button>
            <button class="btn" id="new-file-btn">New File</button>
            <button class="btn" id="delete-file-btn">Delete File</button>
            <button class="btn" id="download-file-btn">Download File</button>
          </div>
        </div>
        <!-- Proxy -->
        <div class="proxy-container" id="panel-proxy" style="display:none;">
          <div class="output" id="proxy-output">Proxy system ready. Enter URL, headers, or custom request.</div>
          <input id="proxy-url" class="chat-input" placeholder="Target URL (https://...)">
          <input id="proxy-method" class="chat-input" style="width:90px;" value="GET">
          <textarea id="proxy-headers" class="chat-input" style="height:40px;" placeholder='{"Authorization":"Bearer ..."}'></textarea>
          <textarea id="proxy-body" class="chat-input" style="height:40px;" placeholder="Body (JSON)"></textarea>
          <button class="btn" id="proxy-send-btn">Send Proxy Request</button>
        </div>
        <!-- AI Chat -->
        <div class="ai-chat" id="panel-ai" style="display:none;">
          <div class="chatbox" id="chatbox"></div>
          <div class="flex">
            <input id="chat-input" class="chat-input" placeholder="Ask anything (code, repo, shell, integrations...)">
            <button class="btn" id="chat-send-btn">Send</button>
          </div>
        </div>
        <!-- Copilot Cookbook -->
        <div class="cookbook-container" id="panel-cookbook" style="display:none;">
          <div class="cookbook-header">
            <h3>ü§ñ GitHub Copilot Chat Cookbook</h3>
            <p>Mobile-First AI Development Prompts & Examples</p>
            <div class="cookbook-search">
              <input id="cookbook-search" class="chat-input" placeholder="Search prompts... (e.g., 'android', 'debugging', 'performance')">
              <select id="cookbook-filter" class="chat-input" style="width:150px;">
                <option value="">All Categories</option>
                <option value="communicate">üí¨ Communication</option>
                <option value="debugging">üêõ Debugging</option>
                <option value="refactoring">üîß Refactoring</option>
                <option value="testing">üß™ Testing</option>
                <option value="security">üîí Security</option>
                <option value="mobile-development">üì± Mobile Dev</option>
              </select>
              <select id="cookbook-difficulty" class="chat-input" style="width:120px;">
                <option value="">All Levels</option>
                <option value="Simple">Simple</option>
                <option value="Intermediate">Intermediate</option>
                <option value="Advanced">Advanced</option>
              </select>
            </div>
          </div>
          <div class="cookbook-content" id="cookbook-content">
            <div class="cookbook-example-list" id="cookbook-examples"></div>
          </div>
          <div class="cookbook-detail" id="cookbook-detail" style="display:none;">
            <button class="btn" id="cookbook-back">‚Üê Back to Examples</button>
            <div id="cookbook-detail-content"></div>
          </div>
        </div>
        <!-- Settings -->
        <div class="output" id="panel-settings" style="display:none;">
          <h3>System Settings</h3>
          <label>AI API Key: <input id="settings-ai-key" class="chat-input" placeholder="Paste DeepSeek/HF token"></label>
          <label>Proxy Default Headers: <textarea id="settings-proxy-headers" class="chat-input" style="height:40px;"></textarea></label>
          <label>Theme: <select id="settings-theme" class="chat-input">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select></label>
        </div>
      </div>
    </div>
  </div>
  <script src="copilot-cookbook.js"></script>
  <script>
    /* ==================== State & Filesystem ==================== */
    let files = {
      "README.md": "# Quantum WebIDE\nIndustry-standard, mobile-first, privileged proxy shell IDE.",
      "main.sh": "#!/bin/bash\necho 'Privileged shell ready.'",
      "proxy.js": "// Proxy hooks\nfunction request(){/*...*/}"
    };
    let activeFile = "README.md";
    let aiKey = "";
    let proxyHeaders = {};
    let theme = "dark";
    // File ops
    function updateFileList() {
      const list = document.getElementById('file-list');
      list.innerHTML = '';
      Object.keys(files).forEach(fname => {
        const btn = document.createElement('button');
        btn.textContent = fname;
        btn.className = 'file-btn' + (fname === activeFile ? ' active' : '');
        btn.onclick = () => openFile(fname);
        list.appendChild(btn);
      });
    }
    function openFile(fname) {
      activeFile = fname;
      document.getElementById('editor').value = files[fname] || '';
      updateFileList();
    }
    document.getElementById('save-file-btn').onclick = () => {
      files[activeFile] = document.getElementById('editor').value;
      updateFileList();
    };
    document.getElementById('new-file-btn').onclick = () => {
      const fname = prompt("New file name:");
      if (fname && !files[fname]) {
        files[fname] = "";
        openFile(fname);
      }
    };
    document.getElementById('delete-file-btn').onclick = () => {
      if (confirm("Delete " + activeFile + "?")) {
        delete files[activeFile];
        activeFile = Object.keys(files)[0] || '';
        openFile(activeFile);
      }
    };
    document.getElementById('download-file-btn').onclick = () => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([files[activeFile]], {type: "text/plain"}));
      a.download = activeFile;
      a.click();
    };
    updateFileList();
    openFile(activeFile);

    /* ==================== Navigation ==================== */
    function showPanel(panel) {
      ["panel-terminal","panel-editor","panel-proxy","panel-ai","panel-settings"].forEach(id => {
        document.getElementById(id).style.display = (id === panel) ? "" : "none";
      });
      document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('nav-' + panel.replace('panel-','')).classList.add('active');
    }
    document.getElementById('nav-terminal').onclick = () => showPanel("panel-terminal");
    document.getElementById('nav-editor').onclick = () => showPanel("panel-editor");
    document.getElementById('nav-proxy').onclick = () => showPanel("panel-proxy");
    document.getElementById('nav-ai').onclick = () => showPanel("panel-ai");
    document.getElementById('nav-cookbook').onclick = () => {
      showPanel("panel-cookbook");
      initializeCookbook();
    };
    document.getElementById('nav-settings').onclick = () => showPanel("panel-settings");
    showPanel("panel-terminal");

    /* ==================== Copilot Cookbook ==================== */
    let currentCookbookView = 'list';
    let filteredExamples = [];

    function initializeCookbook() {
      if (typeof copilotCookbook === 'undefined') {
        document.getElementById('cookbook-examples').innerHTML = '<p style="color: #ef4444;">Cookbook not loaded. Please ensure copilot-cookbook.js is available.</p>';
        return;
      }
      
      setupCookbookEventListeners();
      displayCookbookExamples();
    }

    function setupCookbookEventListeners() {
      // Search functionality
      document.getElementById('cookbook-search').addEventListener('input', (e) => {
        filterAndDisplayExamples();
      });

      // Category filter
      document.getElementById('cookbook-filter').addEventListener('change', (e) => {
        filterAndDisplayExamples();
      });

      // Difficulty filter
      document.getElementById('cookbook-difficulty').addEventListener('change', (e) => {
        filterAndDisplayExamples();
      });

      // Back button
      document.getElementById('cookbook-back').addEventListener('click', () => {
        document.getElementById('cookbook-content').style.display = 'block';
        document.getElementById('cookbook-detail').style.display = 'none';
        currentCookbookView = 'list';
      });
    }

    function filterAndDisplayExamples() {
      const searchTerm = document.getElementById('cookbook-search').value.toLowerCase();
      const categoryFilter = document.getElementById('cookbook-filter').value;
      const difficultyFilter = document.getElementById('cookbook-difficulty').value;

      let examples = [];

      if (searchTerm) {
        examples = copilotCookbook.search(searchTerm);
      } else if (categoryFilter) {
        examples = copilotCookbook.getByCategory(categoryFilter);
      } else {
        // Get all examples
        for (const [categoryKey, category] of Object.entries(copilotCookbook.categories)) {
          for (const example of category.examples) {
            examples.push({
              ...example,
              category: category.name,
              categoryKey: categoryKey,
              categoryIcon: category.icon
            });
          }
        }
      }

      if (difficultyFilter) {
        examples = examples.filter(ex => ex.difficulty === difficultyFilter);
      }

      filteredExamples = examples;
      displayExamples(examples);
    }

    function displayCookbookExamples() {
      filterAndDisplayExamples();
    }

    function displayExamples(examples) {
      const container = document.getElementById('cookbook-examples');
      
      if (examples.length === 0) {
        container.innerHTML = '<p style="color: #a7f3d0;">No examples found. Try different search terms or filters.</p>';
        return;
      }

      container.innerHTML = examples.map(example => `
        <div class="cookbook-example ${example.androidSpecific ? 'android' : ''}" data-id="${example.id}">
          <div class="cookbook-example-title">
            ${example.categoryIcon || 'üìù'} ${example.title}
            <span class="cookbook-example-difficulty ${example.difficulty}">${example.difficulty}</span>
          </div>
          <div class="cookbook-example-description">${example.description}</div>
          <div class="cookbook-example-tags">
            ${example.tags.map(tag => 
              `<span class="cookbook-tag ${tag === 'android' || tag === 'mobile' || tag === 'arm64' ? 'android' : ''}">${tag}</span>`
            ).join('')}
          </div>
        </div>
      `).join('');

      // Add click handlers
      container.querySelectorAll('.cookbook-example').forEach(el => {
        el.addEventListener('click', () => {
          const exampleId = el.dataset.id;
          const example = copilotCookbook.getById(exampleId);
          if (example) {
            showCookbookDetail(example);
          }
        });
      });
    }

    function showCookbookDetail(example) {
      document.getElementById('cookbook-content').style.display = 'none';
      document.getElementById('cookbook-detail').style.display = 'block';
      currentCookbookView = 'detail';

      const detailContent = document.getElementById('cookbook-detail-content');
      detailContent.innerHTML = `
        <div class="cookbook-detail">
          <h4>${example.categoryIcon || 'üìù'} ${example.title}</h4>
          <div style="margin-bottom: 1em;">
            <span class="cookbook-example-difficulty ${example.difficulty}">${example.difficulty}</span>
            <span style="color: #a7f3d0; margin-left: 1em;">${example.category}</span>
            ${example.androidSpecific ? '<span style="color: #10b981; margin-left: 1em;">ü§ñ Android/ARM64 Optimized</span>' : ''}
          </div>
          
          <p style="color: #e0e7ff; margin-bottom: 1.5em;">${example.description}</p>
          
          <div class="cookbook-prompt">
            <h5 style="color: #fbbf24; margin-bottom: 0.5em;">üìã Copilot Chat Prompt:</h5>
            <pre>${example.prompt}</pre>
          </div>
          
          <div class="cookbook-use-case">
            <h5>üí° When to use this prompt:</h5>
            <p style="color: #d1d5db;">${example.useCase}</p>
          </div>
          
          <div style="margin-top: 1.5em;">
            <button class="btn" onclick="copyCookbookPrompt('${example.id}')">üìã Copy Prompt</button>
            <button class="btn" onclick="useCookbookPromptInChat('${example.id}')">üí¨ Use in AI Chat</button>
            ${example.androidSpecific ? '<button class="btn" onclick="showAndroidTips()" style="background: #10b981;">ü§ñ Android Tips</button>' : ''}
          </div>
          
          <div class="cookbook-example-tags" style="margin-top: 1em;">
            ${example.tags.map(tag => 
              `<span class="cookbook-tag ${tag === 'android' || tag === 'mobile' || tag === 'arm64' ? 'android' : ''}">${tag}</span>`
            ).join('')}
          </div>
        </div>
      `;
    }

    function copyCookbookPrompt(exampleId) {
      const example = copilotCookbook.getById(exampleId);
      if (example && navigator.clipboard) {
        navigator.clipboard.writeText(example.prompt).then(() => {
          // Show success feedback
          const btn = event.target;
          const originalText = btn.textContent;
          btn.textContent = '‚úÖ Copied!';
          btn.style.background = '#10b981';
          setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '#6366f1';
          }, 2000);
        });
      }
    }

    function useCookbookPromptInChat(exampleId) {
      const example = copilotCookbook.getById(exampleId);
      if (example) {
        // Switch to AI chat panel
        showPanel("panel-ai");
        // Fill the chat input with the prompt
        document.getElementById('chat-input').value = example.prompt;
        // Focus the input
        document.getElementById('chat-input').focus();
      }
    }

    function showAndroidTips() {
      alert('ü§ñ Android/ARM64 Development Tips:\\n\\n' +
            '‚Ä¢ Use ARM64-specific optimizations when available\\n' +
            '‚Ä¢ Consider battery and memory constraints on mobile\\n' +
            '‚Ä¢ Test on actual ARM64 devices when possible\\n' +
            '‚Ä¢ Use Android-specific APIs and patterns\\n' +
            '‚Ä¢ Follow Material Design guidelines\\n' +
            '‚Ä¢ Optimize for different screen sizes and orientations');
    }

    /* ==================== Terminal (xterm.js) ==================== */
    const term = new Terminal({ theme: { background: '#181f2a', foreground: '#5eead4' }, fontFamily: 'Fira Code, monospace', fontSize: 15 });
    term.open(document.getElementById('terminal'));
    term.write('QuantumWebIDE Terminal Ready!\r\n> ');
    let termCmd = '';
    term.onData(data => {
      if (data === '\r') {
        term.write('\r\n');
        processTerminalCmd(termCmd.trim());
        termCmd = '';
        term.write('> ');
      } else if (data === '\u007F') {
        if (termCmd.length > 0) {
          term.write('\b \b');
          termCmd = termCmd.slice(0, -1);
        }
      } else {
        term.write(data);
        termCmd += data;
      }
    });
    function processTerminalCmd(cmd) {
      if (!cmd) return;
      if (cmd === 'help') {
        term.write('Commands: help, ls, cat <file>, edit <file>, proxy <url>, ai <msg>\r\n');
        return;
      }
      if (cmd === 'ls') {
        term.write(Object.keys(files).join('  ') + '\r\n');
        return;
      }
      if (cmd.startsWith('cat ')) {
        const f = cmd.slice(4).trim();
        term.write((files[f] || 'File not found.') + '\r\n');
        return;
      }
      if (cmd.startsWith('edit ')) {
        const f = cmd.slice(5).trim();
        if (files[f]) {
          openFile(f);
          showPanel("panel-editor");
          term.write('Editing ' + f + '\r\n');
        } else {
          term.write('File not found.\r\n');
        }
        return;
      }
      if (cmd.startsWith('proxy ')) {
        showPanel("panel-proxy");
        document.getElementById('proxy-url').value = cmd.slice(6).trim();
        term.write('Proxy panel opened\r\n');
        return;
      }
      if (cmd.startsWith('ai ')) {
        showPanel("panel-ai");
        runAIChat(cmd.slice(3).trim(),"cli",out=>term.write(out+'\r\n'));
        return;
      }
      term.write('Unknown command. Type help.\r\n');
    }

    /* ==================== Proxy System ==================== */
    document.getElementById('proxy-send-btn').onclick = async () => {
      const url = document.getElementById('proxy-url').value.trim();
      const method = document.getElementById('proxy-method').value.trim();
      let headers = {};
      try { headers = JSON.parse(document.getElementById('proxy-headers').value || "{}"); } catch(e){}
      let body = document.getElementById('proxy-body').value.trim();
      let options = { method, headers };
      if (body) options.body = body;
      try {
        let res = await fetch(url, options);
        let text = await res.text();
        document.getElementById('proxy-output').textContent = text.slice(0,2000);
      } catch(e) {
        document.getElementById('proxy-output').textContent = "Proxy error: "+e.message;
      }
    };

    /* ==================== AI Chat ==================== */
    function addChatMsg(user, text) {
      let chatbox = document.getElementById('chatbox');
      let div = document.createElement('div');
      div.className = 'chat-msg';
      div.innerHTML = `<span class="${user==='AI'?'chat-ai':'chat-user'}">${user}:</span> <span class="chat-text">${text}</span>`;
      chatbox.appendChild(div);
      chatbox.scrollTop = chatbox.scrollHeight;
    }
    async function queryAI(messages, model="deepseek-ai/DeepSeek-R1:fireworks-ai") {
      if(!aiKey) return "AI key not set. Paste in settings.";
      try {
        const response = await fetch("https://router.huggingface.co/v1/chat/completions",{
          headers: { Authorization: "Bearer "+aiKey, "Content-Type":"application/json"},
          method: "POST",
          body: JSON.stringify({messages,top_p:1,model}),
        });
        const result = await response.json();
        if(result.choices && result.choices.length>0) return result.choices[0].message.content;
        return result.error||"AI error: Unexpected response";
      } catch(e){ return "AI error: "+e.message;}
    }
    async function runAIChat(prompt,source="chat",cb) {
      addChatMsg(source==="cli"?"CLI":"You",prompt);
      let repoContext = Object.keys(files).map(f=>`${f}:\n${files[f].slice(0,300)}`).join('\n\n');
      let userMsg = `Mobile-First Quantum WebIDE, Android 10+/Aarch64. Files:\n${repoContext}\n\n${prompt}`;
      let answer = await queryAI([{role:"user",content:userMsg}]);
      addChatMsg("AI",answer);
      if(cb) cb(answer);
    }
    document.getElementById('chat-send-btn').onclick = () => {
      let val = document.getElementById('chat-input').value.trim();
      if(!val) return;
      runAIChat(val);
      document.getElementById('chat-input').value = '';
    };

    /* ==================== Settings ==================== */
    document.getElementById('settings-ai-key').onchange = e => {
      aiKey = e.target.value.trim();
      document.getElementById('status-indicator').textContent = aiKey ? "AI Ready" : "";
    };
    document.getElementById('settings-proxy-headers').onchange = e => {
      try{proxyHeaders=JSON.parse(e.target.value);}catch{}
    };
    document.getElementById('settings-theme').onchange = e => {
      theme = e.target.value;
      document.body.style.background = theme==="light"?"#f9fafb":"#111827";
      document.body.style.color = theme==="light"?"#181f2a":"#e5e7eb";
    };

    /* ==================== Security/Audit Hooks ==================== */
    // Example: Web Crypto for privileged operations
    async function signMessage(msg) {
      const enc = new TextEncoder();
      const key = await window.crypto.subtle.generateKey({name:"HMAC",hash:"SHA-256"},true,["sign","verify"]);
      const sig = await window.crypto.subtle.sign("HMAC",key,enc.encode(msg));
      return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    // Example: Auth flow
    function oauth2Login() {
      window.open("https://accounts.google.com/o/oauth2/auth?scope=email&response_type=token&client_id=YOUR_CLIENT_ID&redirect_uri="+location.href,"_blank");
    }
    // Example: ServiceWorker for offline
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("sw.js").catch(()=>{});
    }

    /* ==================== Android/Aarch64 Detection ==================== */
    function androidCompatCheck(){
      let ua = navigator.userAgent;
      return /Android 10|aarch64|arm64|Linux/.test(ua);
    }
    if(!androidCompatCheck()) document.getElementById('status-indicator').textContent += " | Non-Android10/Aarch64";

    /* ==================== End ==================== */
    // Layered rationale: All modules reference /reference vault, code and UI are audit-ready and extensible.
  </script>
  <!--
  References:
  - /reference vault
  - OWASP Secure Coding
  - Google Web Fundamentals
  - MDN Web Docs
  - Android 10+ Compatibility
  - xterm.js docs
  - Web Crypto API
  - WebSockets API
  - ServiceWorkers
  - OAuth2
  - Proxy servers
  -->
</body>
</html>